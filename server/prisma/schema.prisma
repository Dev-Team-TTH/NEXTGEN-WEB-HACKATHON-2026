generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Users {
  userId      String  @id @default(uuid()) // Tự động sinh mã ID cho user mới
  name        String  // Họ và tên
  email       String  @unique // Bắt buộc ĐỘC NHẤT để làm tài khoản đăng nhập
  password    String  // Mật khẩu (Sẽ được mã hóa bcrypt ở Backend)
  
  phone       String? // Số điện thoại liên hệ
  address     String? // Địa chỉ sinh sống
  
  // Phân quyền và Nơi làm việc
  role        String  @default("STAFF") // Các role: "ADMIN" (Tổng công ty), "MANAGER" (Quản lý kho), "STAFF" (Thủ kho)
}

model Products {
  productId      String   @id
  name           String
  price          Float
  rating         Float?
  stockQuantity  Int      @default(0) // Sẽ chỉ thay đổi khi phiếu ĐÃ ĐƯỢC DUYỆT
  
  baseUnit       String   @default("Cái")
  largeUnit      String?
  conversionRate Int      @default(1)
  imageUrl       String?

  purchasePrice  Float?   @default(0)
  status         String   @default("ACTIVE")
  category       String?
  description    String?
  reorderPoint   Int      @default(10)
  reorderUnit    String?
  maxStock       Int?
  
  hasVariants    Boolean  @default(false)
  hasBatches     Boolean  @default(false)

  Variants              ProductVariant[]
  Batches               ProductBatch[] // Vẫn giữ để tra cứu nhanh toàn bộ lô của SP
  InventoryTransactions InventoryTransaction[]
  MasterDataRequests    MasterDataRequest[]
}

model ProductVariant {
  variantId      String   @id @default(uuid())
  productId      String
  sku            String   @unique 
  attributes     String   
  additionalPrice Float   @default(0) 
  stockQuantity  Int      @default(0) 

  product        Products @relation(fields: [productId], references: [productId], onDelete: Cascade)
  
  Batches        ProductBatch[] // MỐI QUAN HỆ CỐT LÕI: 1 Biến thể có nhiều Lô
  Transactions   InventoryTransaction[]
}

model ProductBatch {
  batchId        String   @id @default(uuid())
  batchNumber    String   
  
  productId      String
  variantId     String?
  
  manufactureDate DateTime? 
  expiryDate      DateTime  
  stockQuantity   Int      @default(0) 

  product        Products @relation(fields: [productId], references: [productId], onDelete: Cascade)
  variant       ProductVariant? @relation(fields: [variantId], references: [variantId], onDelete: Cascade)
  
  Transactions   InventoryTransaction[]

  @@unique([variantId, batchNumber]) // RÀNG BUỘC: Mỗi biến thể chỉ có 1 số lô duy nhất (Dùng để Gộp Lô)
}

// CẬP NHẬT BẢNG THỂ KHO (TRANSACTIONS) ĐỂ GẮN VỚI LÔ/BIẾN THỂ
model InventoryTransaction {
  transactionId  String   @id @default(uuid())
  
  productId      String
  variantId      String?
  batchId        String?  
  
  newBatchNumber String?
  expiryDate     DateTime?
  location       String?  

  timestamp      DateTime @default(now())
  type           String   // IN / OUT / TRANSFER (Luân chuyển)
  quantity       Int
  note           String?

  status         String   @default("PENDING") 
  createdBy      String?
  approvedBy     String?
  approvedAt     DateTime?

  // Khóa ngoại
  product        Products @relation(fields: [productId], references: [productId], onDelete: Cascade)
  variant        ProductVariant? @relation(fields: [variantId], references: [variantId], onDelete: Cascade)
  batch          ProductBatch? @relation(fields: [batchId], references: [batchId], onDelete: Cascade)
}

// Giữ lại chi phí để làm báo cáo Dashboard (VD: Chi phí bảo trì tài sản, phí vận chuyển)
model Expenses {
  expenseId String   @id
  category  String
  amount    Float
  timestamp DateTime
}

model ExpenseSummary {
  expenseSummaryId  String              @id
  totalExpenses     Float
  date              DateTime
  ExpenseByCategory ExpenseByCategory[]
}

model ExpenseByCategory {
  expenseByCategoryId String         @id
  expenseSummaryId    String
  category            String
  amount              BigInt
  date                DateTime
  expenseSummary      ExpenseSummary @relation(fields: [expenseSummaryId], references: [expenseSummaryId])
}

model Assets {
  assetId        String   @id @default(uuid())
  name           String
  category       String
  status         String
  assignedTo     String?
  purchaseDate   DateTime
  purchasePrice  Float
  currentValue   Float
  location       String?

  imageUrl       String?  // <-- THÊM DÒNG NÀY

  depreciationMonths Int?      @default(0)
  maintenanceCycle   Int?      @default(0) // Chu kỳ bảo trì: Bao nhiêu tháng 1 lần?
  lastMaintenance    DateTime? // Ngày bảo trì gần nhất
  nextMaintenance    DateTime? // Hạn bảo trì tiếp theo (Hệ thống tự tính)

  AssetRequests  AssetRequest[]
  AssetHistories AssetHistory[]
}

// --- BẢNG YÊU CẦU TÀI SẢN (ENTERPRISE WMS) ---
model AssetRequest {
  requestId      String   @id @default(uuid())
  assetId        String?  // Có thể Null nếu là phiếu MUA MỚI tài sản
  requestType    String   // "CREATE" (Mua mới), "UPDATE" (Sửa/Bàn giao), "DELETE" (Thanh lý)
  requestedBy    String?  @default("NhanVien_01")
  timestamp      DateTime @default(now())
  status         String   @default("PENDING") // PENDING, APPROVED, REJECTED
  approvedBy     String?
  approvedAt     DateTime?

  // Lưu các thông tin tài sản muốn tạo/sửa
  name           String?
  category       String?
  assetStatus    String?  // Tình trạng tài sản (Sẵn sàng, Đang sử dụng...)
  assignedTo     String?
  purchaseDate   DateTime?
  purchasePrice  Float?
  currentValue   Float?
  location       String?
  imageUrl       String?

  depreciationMonths Int?
  maintenanceCycle   Int?
  lastMaintenance    DateTime?
  nextMaintenance    DateTime?

  asset          Assets?  @relation(fields: [assetId], references: [assetId], onDelete: Cascade)
}

model AssetHistory {
  historyId    String   @id @default(uuid())
  assetId      String
  actionType   String   // Các loại: CREATED, HANDOVER (Bàn giao), MAINTENANCE (Bảo trì), BROKEN (Hỏng), UPDATED
  description  String   // Mô tả chi tiết (VD: "Bàn giao cho Nguyễn Văn A")
  changedBy    String?  @default("System") // Người thực hiện duyệt / thao tác
  timestamp    DateTime @default(now())

  asset        Assets   @relation(fields: [assetId], references: [assetId], onDelete: Cascade)
}

// --- BẢNG MỚI (MÔ HÌNH ENTERPRISE): YÊU CẦU ĐỔI MASTER DATA ---
model MasterDataRequest {
  requestId        String   @id @default(uuid())
  productId        String
  requestedBy      String?  @default("NhanVien_01")
  timestamp        DateTime @default(now())
  status           String   @default("PENDING") // PENDING, APPROVED, REJECTED
  approvedBy       String?
  approvedAt       DateTime?

  // Lưu trữ các dữ liệu mới mà nhân viên muốn đổi
  newName          String?
  newPrice         Float?
  newPurchasePrice Float?
  newCategory      String?
  newDescription   String?
  newStatus        String?
  newImageUrl      String?
  newReorderPoint  Int?

  product          Products @relation(fields: [productId], references: [productId], onDelete: Cascade)
}