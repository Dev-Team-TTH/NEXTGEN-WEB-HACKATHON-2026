generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Users {
  userId      String  @id @default(uuid()) // Tự động sinh mã ID cho user mới
  name        String  // Họ và tên
  email       String  @unique // Bắt buộc ĐỘC NHẤT để làm tài khoản đăng nhập
  password    String  // Mật khẩu (Sẽ được mã hóa bcrypt ở Backend)
  
  phone       String? // Số điện thoại liên hệ
  address     String? // Địa chỉ sinh sống
  
  // Phân quyền và Nơi làm việc
  role        String  @default("STAFF") // Các role: "ADMIN" (Tổng công ty), "MANAGER" (Quản lý kho), "STAFF" (Thủ kho)
  warehouseId String? // ID của Kho mà nhân viên này trực thuộc (ADMIN có thể để trống)
  
  warehouse   Warehouse? @relation(fields: [warehouseId], references: [warehouseId], onDelete: SetNull)
}

model Products {
  productId      String   @id
  name           String
  price          Float
  rating         Float?
  stockQuantity  Int      @default(0) // Sẽ chỉ thay đổi khi phiếu ĐÃ ĐƯỢC DUYỆT
  
  baseUnit       String   @default("Cái")
  largeUnit      String?
  conversionRate Int      @default(1)
  imageUrl       String?

  purchasePrice  Float?   @default(0)
  status         String   @default("ACTIVE")
  category       String?
  description    String?
  reorderPoint   Int      @default(10)
  reorderUnit    String?
  
  hasVariants    Boolean  @default(false)
  hasBatches     Boolean  @default(false)

  Variants              ProductVariant[]
  Batches               ProductBatch[] // Vẫn giữ để tra cứu nhanh toàn bộ lô của SP
  InventoryTransactions InventoryTransaction[]
  WarehouseStocks       WarehouseStock[]
}

model ProductVariant {
  variantId      String   @id @default(uuid())
  productId      String
  sku            String   @unique 
  attributes     String   
  additionalPrice Float   @default(0) 
  stockQuantity  Int      @default(0) 

  product        Products @relation(fields: [productId], references: [productId], onDelete: Cascade)
  
  Batches        ProductBatch[] // MỐI QUAN HỆ CỐT LÕI: 1 Biến thể có nhiều Lô
  Transactions   InventoryTransaction[]
}

model ProductBatch {
  batchId        String   @id @default(uuid())
  batchNumber    String   
  
  productId      String
  variantId      String   // BẮT BUỘC: Lô này phải thuộc về 1 biến thể cụ thể (VD: Lô của Milo 150ML)
  
  manufactureDate DateTime? 
  expiryDate      DateTime  
  stockQuantity   Int      @default(0) 

  product        Products @relation(fields: [productId], references: [productId], onDelete: Cascade)
  variant        ProductVariant @relation(fields: [variantId], references: [variantId], onDelete: Cascade)
  
  Transactions   InventoryTransaction[]

  @@unique([variantId, batchNumber]) // RÀNG BUỘC: Mỗi biến thể chỉ có 1 số lô duy nhất (Dùng để Gộp Lô)
}

// CẬP NHẬT BẢNG THỂ KHO (TRANSACTIONS) ĐỂ GẮN VỚI LÔ/BIẾN THỂ
model InventoryTransaction {
  transactionId  String   @id @default(uuid())
  
  // THÊM DÒNG NÀY: Giao dịch này xảy ra ở kho nào?
  warehouseId    String
  
  productId      String
  variantId      String?
  batchId        String?  
  
  newBatchNumber String?
  expiryDate     DateTime?
  location       String?  

  timestamp      DateTime @default(now())
  type           String   // IN / OUT / TRANSFER (Luân chuyển)
  quantity       Int
  note           String?

  status         String   @default("PENDING") 
  createdBy      String?
  approvedBy     String?
  approvedAt     DateTime?

  // Khóa ngoại
  warehouse      Warehouse @relation(fields: [warehouseId], references: [warehouseId], onDelete: Cascade)
  product        Products @relation(fields: [productId], references: [productId], onDelete: Cascade)
  variant        ProductVariant? @relation(fields: [variantId], references: [variantId], onDelete: Cascade)
  batch          ProductBatch? @relation(fields: [batchId], references: [batchId], onDelete: Cascade)
}

model Warehouse {
  warehouseId   String   @id @default(uuid())
  name          String   
  address       String?
  
  users         Users[]
  transactions  InventoryTransaction[]
  stocks        WarehouseStock[] 
  assets        Assets[] // <-- THÊM DÒNG NÀY (Để 1 Chi nhánh có thể có nhiều Tài sản)
}

// --- BẢNG MỚI: TỒN KHO CHI TIẾT THEO TỪNG KHO ---
model WarehouseStock {
  id            String   @id @default(uuid())
  
  warehouseId   String
  productId     String
  variantId     String?
  batchId       String?  
  
  quantity      Int      @default(0) // Số lượng thực tế tại KHO NÀY

  // Khóa ngoại
  warehouse     Warehouse @relation(fields: [warehouseId], references: [warehouseId], onDelete: Cascade)
  product       Products  @relation(fields: [productId], references: [productId], onDelete: Cascade)
  
  // Ràng buộc: Mỗi sản phẩm/biến thể/lô chỉ có 1 dòng duy nhất trong 1 kho
  @@unique([warehouseId, productId, variantId, batchId]) 
}

// Giữ lại chi phí để làm báo cáo Dashboard (VD: Chi phí bảo trì tài sản, phí vận chuyển)
model Expenses {
  expenseId String   @id
  category  String
  amount    Float
  timestamp DateTime
}

model ExpenseSummary {
  expenseSummaryId  String              @id
  totalExpenses     Float
  date              DateTime
  ExpenseByCategory ExpenseByCategory[]
}

model ExpenseByCategory {
  expenseByCategoryId String         @id
  expenseSummaryId    String
  category            String
  amount              BigInt
  date                DateTime
  expenseSummary      ExpenseSummary @relation(fields: [expenseSummaryId], references: [expenseSummaryId])
}

model Assets {
  assetId        String   @id @default(uuid())
  name           String
  category       String   // VD: Máy móc, Nội thất, Điện tử...
  
  purchaseDate   DateTime
  purchasePrice  Float
  currentValue   Float    // Giá trị hiện tại (sau khấu hao)
  
  status         String   @default("ACTIVE") // ACTIVE, MAINTENANCE, BROKEN, DISPOSED
  location       String?  // Vị trí cụ thể trong chi nhánh (VD: Phòng họp A, Khu sản xuất 1)
  assignedTo     String?  // Có thể lưu userId của người đang giữ tài sản này
  
  // THÊM 2 DÒNG NÀY ĐỂ GẮN TÀI SẢN VÀO CHI NHÁNH
  warehouseId    String?  // Nếu rỗng nghĩa là tài sản thuộc Tổng công ty chưa phân bổ
  warehouse      Warehouse? @relation(fields: [warehouseId], references: [warehouseId], onDelete: SetNull)
}